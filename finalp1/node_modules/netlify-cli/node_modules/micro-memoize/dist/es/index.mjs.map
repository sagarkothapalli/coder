{"version":3,"file":"index.mjs","sources":["../../../src/CacheEventEmitter.ts","../../../src/maxArgs.ts","../../../src/serialize.ts","../../../src/utils.ts","../../../src/Cache.ts","../../../src/expires.ts","../../../src/stats.ts","../../../src/index.ts"],"sourcesContent":["import type { Cache } from './Cache.js';\nimport type { CacheEventListener, CacheEventType, CacheNode } from './internalTypes.js';\n\ntype ListenerMap<Fn extends (...args: any[]) => any> = Partial<\n  Record<string, Set<CacheEventListener<CacheEventType, Fn>>>\n>;\n\nexport class CacheEventEmitter<Fn extends (...args: any[]) => any> {\n  /**\n   * The list of [l]isteners for the given [t]ype.\n   */\n  l: ListenerMap<Fn> = {};\n\n  /**\n   * The [c]ache the emitter is associated with.\n   */\n  private c: Cache<Fn>;\n\n  constructor(cache: Cache<Fn>) {\n    this.c = cache;\n  }\n\n  /**\n   * Method to [a]dd a listener for the given cache change event.\n   */\n  a<Type extends CacheEventType>(type: Type, listener: CacheEventListener<Type, Fn>): void {\n    const listeners = this.l[type];\n\n    if (!listeners) {\n      this.l[type] = new Set([listener]);\n    } else if (!listeners.has(listener)) {\n      listeners.add(listener);\n    }\n  }\n\n  /**\n   * Method to [n]otify all listeners for the given cache change event.\n   */\n  n(type: CacheEventType, node: CacheNode<Fn>, reason?: string): void {\n    const listeners = this.l[type];\n\n    if (!listeners) {\n      return;\n    }\n\n    listeners.forEach((listener) => {\n      listener({\n        cache: this.c,\n        key: node.k,\n        reason,\n        value: node.v,\n        type,\n      });\n    });\n  }\n\n  /**\n   * Method to [r]emove a listener for the given cache change event.\n   */\n  r<Type extends CacheEventType>(type: Type, listener: CacheEventListener<Type, Fn>): void {\n    const listeners = this.l[type];\n\n    if (!listeners) {\n      return;\n    }\n\n    listeners.delete(listener);\n\n    if (!listeners.size) {\n      this.l[type] = undefined;\n    }\n  }\n}\n","import type { Key, TransformKey } from './internalTypes.js';\n\n/**\n * Create a method that takes the first N number of items from the array (faster than slice).\n */\nexport function getMaxArgsTransformKey<Fn extends (...args: any[]) => any>(\n  maxArgs: number,\n): TransformKey<Fn> | undefined {\n  if (maxArgs === 1) {\n    return (args: Key) => (maxArgs >= args.length ? args : [args[0]]);\n  }\n\n  if (maxArgs === 2) {\n    return (args: Key) => (maxArgs >= args.length ? args : [args[0], args[1]]);\n  }\n\n  return (args: Key) => {\n    if (maxArgs >= args.length) {\n      return args;\n    }\n\n    const clone = new Array(maxArgs);\n\n    for (let index = 0; index < maxArgs; ++index) {\n      clone[index] = args[index];\n    }\n\n    return clone;\n  };\n}\n","import { stringify } from 'fast-stringify';\nimport type { Key } from './internalTypes.js';\n\n/**\n * Default replacer used when stringifying to ensure values that would normally be\n * ignored are respected.\n */\nfunction replacer(_key: string, value: any): any {\n  const type = typeof value;\n\n  return type === 'function' || type === 'symbol' ? value.toString() : value;\n}\n\n/**\n * Default serializer used when `serialize` option set to `true`.\n */\nexport function transformKeySerialized<Fn extends (...args: any[]) => any>(args: Parameters<Fn>): [string] {\n  return [stringify(args, { replacer })];\n}\n\n/**\n * Determines whether the serialized keys are equal to one another.\n */\nexport function isSerializedKeyEqual(prevKey: Key, nextKey: Key): boolean {\n  return prevKey[0] === nextKey[0];\n}\n","import type { Memoized, Options } from './internalTypes.js';\n\n/**\n * Whether the value passed is a memoized function via `micro-memoize`.\n */\nexport function isMemoized<Fn extends (...args: any) => any, Opts extends Options<Fn>>(\n  fn: any,\n): fn is Memoized<Fn, Opts> {\n  return typeof fn === 'function' && fn.isMemoized;\n}\n\n/**\n * Determine whether the value passed is a numeric value for usage in common contexts.\n * This is a positive, finite integer.\n */\nexport function isNumericValueValid(value: any): value is number {\n  return typeof value === 'number' && value >= 0 && Number.isFinite(value);\n}\n","import { deepEqual, shallowEqual } from 'fast-equals';\nimport { CacheEventEmitter } from './CacheEventEmitter.js';\nimport type {\n  CacheEntry,\n  CacheEventType,\n  CacheEventListener,\n  CacheNode,\n  CacheSnapshot,\n  Key,\n  Options,\n  IsKeyEqual,\n  TransformKey,\n} from './internalTypes.js';\nimport { getMaxArgsTransformKey } from './maxArgs.js';\nimport { isSerializedKeyEqual, transformKeySerialized } from './serialize.js';\nimport { isNumericValueValid } from './utils.js';\n\nexport class Cache<Fn extends (...args: any[]) => any> {\n  /**\n   * The current [c]ount of entries in the cache.\n   */\n  c = 0;\n  /**\n   * Whether the entire key is [e]qual to an existing key in cache.\n   */\n  e: IsKeyEqual;\n  /**\n   * The [h]ead of the cache linked list.\n   */\n  h: CacheNode<Fn> | undefined;\n  /**\n   * The transformer for the [k]ey stored in cache.\n   */\n  k: Options<Fn>['transformKey'] | undefined;\n  /**\n   * Event emitter for `[o]`n events.\n   */\n  o: CacheEventEmitter<Fn> | undefined;\n  /**\n   * Whether to await the [p]romise returned by the function.\n   */\n  p: Options<Fn>['async'];\n  /**\n   * The maximum [s]ize of the cache.\n   */\n  s: number;\n  /**\n   * The [t]ail of the cache linked list.\n   */\n  t: CacheNode<Fn> | undefined;\n\n  constructor(options: Options<Fn>) {\n    const { async, maxSize } = options;\n\n    this.e = getIsKeyEqual(options);\n    this.k = getTransformKey(options);\n    this.p = typeof async === 'boolean' && async;\n    this.s = isNumericValueValid(maxSize) ? maxSize : 1;\n  }\n\n  /**\n   * The size of the populated cache.\n   */\n  get size(): number {\n    return this.c;\n  }\n\n  /**\n   * The [key, value] pairs for the existing entries in cache.\n   */\n  get snapshot(): CacheSnapshot<Fn> {\n    const entries: Array<CacheEntry<Fn>> = [];\n    const keys: Key[] = [];\n    const values: Array<ReturnType<Fn>> = [];\n\n    let node = this.h;\n    let size = 0;\n\n    while (node != null) {\n      keys.push(node.k);\n      values.push(node.v);\n      entries.push([node.k, node.v]);\n      ++size;\n\n      node = node.n;\n    }\n\n    return { entries, keys, size, values };\n  }\n\n  /**\n   * Clear the cache.\n   */\n  clear(reason = 'explicit clear'): void {\n    if (!this.h) {\n      return;\n    }\n\n    const emitter = this.o;\n\n    let nodes: Array<CacheNode<Fn>> | undefined;\n\n    if (emitter) {\n      nodes = [];\n\n      let node: CacheNode<Fn> | undefined = this.h;\n\n      while (node != null) {\n        nodes.push(node);\n        node = node.n;\n      }\n    }\n\n    this.h = this.t = undefined;\n    this.c = 0;\n\n    if (emitter && nodes) {\n      for (let index = 0; index < nodes.length; ++index) {\n        emitter.n('delete', nodes[index]!, reason);\n      }\n    }\n  }\n\n  /**\n   * Delete the entry for the key based on the given `args` in cache.\n   */\n  delete(args: Parameters<Fn>, reason = 'explicit delete'): boolean {\n    const node = this.g(this.k ? this.k(args) : args);\n\n    if (node) {\n      this.d(node, reason);\n\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Get the value in cache based on the given `args`.\n   */\n  get(args: Parameters<Fn>, reason = 'explicit get'): ReturnType<Fn> | undefined {\n    const node = this.g(this.k ? this.k(args) : args);\n\n    if (node) {\n      if (node !== this.h) {\n        this.u(node, reason, true);\n      } else if (this.o) {\n        this.o.n('hit', node, reason);\n      }\n\n      return node.v;\n    }\n  }\n\n  /**\n   * Determine whether the given `args` have a related entry in the cache.\n   */\n  has(args: Parameters<Fn>): boolean {\n    return !!this.g(this.k ? this.k(args) : args);\n  }\n\n  /**\n   * Remove the given `listener` for the given `type` of cache event.\n   */\n  off<Type extends CacheEventType>(type: Type, listener: CacheEventListener<Type, Fn>): void {\n    this.o && this.o.r(type, listener);\n  }\n\n  /**\n   * Add the given `listener` for the given `type` of cache event.\n   */\n  on<Type extends CacheEventType>(type: Type, listener: CacheEventListener<Type, Fn>): void {\n    if (!this.o) {\n      this.o = new CacheEventEmitter<Fn>(this);\n    }\n\n    this.o.a(type, listener);\n  }\n\n  /**\n   * Add or update the cache entry for the given `key`.\n   */\n  set(key: Parameters<Fn>, value: ReturnType<Fn>, reason = 'explicit set'): void {\n    const normalizedKey = this.k ? this.k(key) : key;\n\n    let node = this.g(normalizedKey);\n\n    if (node) {\n      const prevValue = node.v;\n\n      node.v = value;\n\n      if (this.p && value !== prevValue) {\n        node.v = this.w(node);\n      }\n\n      node !== this.h && this.u(node, reason, false);\n    } else {\n      node = this.n(normalizedKey, value);\n    }\n  }\n\n  /**\n   * Method to [d]elete the given `node` from the cache.\n   */\n  d(node: CacheNode<Fn>, reason: string): void {\n    const next = node.n;\n    const prev = node.p;\n\n    if (next) {\n      next.p = prev;\n    } else {\n      this.t = prev;\n    }\n\n    if (prev) {\n      prev.n = next;\n    } else {\n      this.h = next;\n    }\n\n    --this.c;\n\n    node.r = true;\n\n    this.o && this.o.n('delete', node, reason);\n  }\n\n  /**\n   * Method to [g]et an existing node from cache based on the given `key`.\n   */\n  g(key: Key): CacheNode<Fn> | undefined {\n    let node = this.h;\n\n    if (!node || node.r) {\n      return;\n    }\n\n    if (this.e(node.k, key)) {\n      return node;\n    }\n\n    if (this.h === this.t) {\n      return;\n    }\n\n    node = node.n;\n\n    while (node) {\n      if (node.r) {\n        return;\n      }\n\n      if (this.e(node.k, key)) {\n        return node;\n      }\n\n      node = node.n;\n    }\n  }\n\n  /**\n   * Method to create a new [n]ode and set it at the head of the linked list.\n   */\n  n(key: Key, value: ReturnType<Fn>, reason?: string): CacheNode<Fn> {\n    const prevHead = this.h;\n    const prevTail = this.t;\n    const node = { k: key, n: prevHead, p: undefined, v: value };\n\n    if (this.p) {\n      node.v = this.w(node);\n    }\n\n    this.h = node;\n\n    if (prevHead) {\n      prevHead.p = node;\n    } else {\n      this.t = node;\n    }\n\n    if (++this.c > this.s && prevTail) {\n      this.d(prevTail, 'evicted');\n    }\n\n    this.o && this.o.n('add', node, reason);\n\n    return node;\n  }\n\n  /**\n   * Method to [u]date the location of the given `node` in cache.\n   */\n  u(node: CacheNode<Fn>, reason: string | undefined, hit: boolean): void {\n    const next = node.n;\n    const prev = node.p;\n\n    if (next) {\n      next.p = prev;\n    }\n\n    if (prev) {\n      prev.n = next;\n    }\n\n    if (this.h) {\n      this.h.p = node;\n    }\n\n    node.n = this.h;\n    node.p = undefined;\n\n    this.h = node;\n\n    if (node === this.t) {\n      this.t = prev;\n    }\n\n    if (this.o) {\n      hit && this.o.n('hit', node, reason);\n      this.o.n('update', node, reason);\n    }\n  }\n\n  /**\n   * Method to [w]rap the promise in a handler to automatically delete the\n   * entry if it rejects.\n   */\n  w(node: CacheNode<Fn>): ReturnType<Fn> {\n    const { v: value } = node;\n\n    // If the method does not return a promise for some reason, just keep the\n    // original value.\n    if (value == null || typeof value.then !== 'function') {\n      return value;\n    }\n\n    return value.then(\n      (value: any) => {\n        !node.r && this.o && this.o.n('update', node, 'resolved');\n\n        return value;\n      },\n      (error: unknown) => {\n        !node.r && this.d(node, 'rejected');\n\n        throw error;\n      },\n    );\n  }\n}\n\nfunction getIsKeyEqual<Fn extends (...args: any[]) => any>({\n  isKeyEqual,\n  isKeyItemEqual,\n  serialize,\n}: Options<Fn>): IsKeyEqual {\n  if (typeof isKeyEqual === 'function') {\n    return isKeyEqual;\n  }\n\n  if (serialize) {\n    return isSerializedKeyEqual;\n  }\n\n  const isItemEqual =\n    typeof isKeyItemEqual === 'function'\n      ? isKeyItemEqual\n      : isKeyItemEqual === 'deep'\n        ? deepEqual\n        : isKeyItemEqual === 'shallow'\n          ? shallowEqual\n          : Object.is;\n\n  return function isKeyEqual(prevKey: Key, nextKey: Key): boolean {\n    const length = nextKey.length;\n\n    if (prevKey.length !== length) {\n      return false;\n    }\n\n    if (length === 1) {\n      return isItemEqual(prevKey[0], nextKey[0], 0);\n    }\n\n    for (let index = 0; index < length; ++index) {\n      if (!isItemEqual(prevKey[index], nextKey[index], index)) {\n        return false;\n      }\n    }\n\n    return true;\n  };\n}\n\n/**\n * Get the `transformKey` option based on the options provided.\n */\nfunction getTransformKey<Fn extends (...args: any[]) => any>(options: Options<Fn>): TransformKey<Fn> | undefined {\n  const { maxArgs, serialize, transformKey } = options;\n\n  const transformers = [\n    serialize ? (typeof serialize === 'function' ? serialize : transformKeySerialized) : undefined,\n    isNumericValueValid(maxArgs) ? getMaxArgsTransformKey(maxArgs) : undefined,\n    typeof transformKey === 'function' ? transformKey : undefined,\n  ].filter(Boolean) as Array<(...args: any[]) => any>;\n\n  return transformers.length\n    ? transformers.reduce(\n        (f, g) =>\n          (...args) =>\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n            f(g(...args)),\n      )\n    : undefined;\n}\n","import type { Cache } from './Cache.js';\nimport type {\n  CacheEventListener,\n  GetExpires,\n  Key,\n  Options,\n  ShouldPersist,\n  ShouldRemoveOnExpire,\n} from './internalTypes.js';\nimport { isNumericValueValid } from './utils.js';\n\nexport class ExpirationManager<Fn extends (...args: any[]) => any> {\n  /**\n   * The [c]ache being monitored.\n   */\n  c: Cache<Fn>;\n  /**\n   * Map of [e]xpiration timeouts.\n   */\n  e = new Map<Key, ReturnType<typeof setTimeout>>();\n  /**\n   * Whether the entry in cache should [p]ersist, and therefore not\n   * have any expiration.\n   */\n  p: ShouldPersist<Fn> | undefined;\n  /**\n   * Whether the entry in cache should be [r]emoved on expiration.\n   */\n  r: ShouldRemoveOnExpire<Fn> | undefined;\n  /**\n   * The [t]ime to wait before expiring, or a method that determines that time.\n   */\n  t: number | GetExpires<Fn>;\n  /**\n   * Whether the expiration should [u]pdate when the cache entry is hit.\n   */\n  u: boolean;\n\n  constructor(cache: Cache<Fn>, expires: Required<Options<Fn>>['expires']) {\n    this.c = cache;\n\n    if (typeof expires === 'object') {\n      this.t = expires.after;\n      this.p = expires.shouldPersist;\n      this.r = expires.shouldRemove;\n      this.u = !!expires.update;\n    } else {\n      this.t = expires;\n      this.u = false;\n    }\n\n    this.c.on('add', ({ key, value }) => {\n      this.a(key, value) && this.s(key, value);\n    });\n\n    if (this.u) {\n      // Set up a `hit` listener if we care about updating the expiration.\n      this.c.on('hit', ({ key, value }) => {\n        this.a(key, value) && this.s(key, value);\n      });\n\n      if (this.c.p) {\n        const onResolved: CacheEventListener<'update', Fn> = ({ key, reason, value }) => {\n          if (reason === 'resolved' && this.a(key, value)) {\n            this.s(key, value);\n            // Automatically remove the listener to avoid unnecessary work on updates after\n            // the item is resolved, as that can only ever happen once.\n            this.c.off('update', onResolved);\n          }\n        };\n\n        // If the method is also async, then when the value resolved update the expiration cache.\n        this.c.on('update', onResolved);\n      }\n    }\n\n    this.c.on('delete', ({ key }) => {\n      this.e.has(key) && this.d(key);\n    });\n  }\n\n  get size(): number {\n    return this.e.size;\n  }\n\n  /**\n   * Whether the cache expiration should be set [a]gain, generally after some cache change.\n   */\n  a(key: Key, value: ReturnType<Fn>): boolean {\n    return !!(this.c.g(key) && !this.p?.(key, value, this.c));\n  }\n\n  /**\n   * Method to [d]elete the expiration.\n   */\n  d(key: Key): void {\n    const expiration = this.e.get(key);\n\n    if (expiration) {\n      clearTimeout(expiration);\n      this.e.delete(key);\n    }\n  }\n\n  /**\n   * Method to [s]et the new expiration. If one is present for the given `key`, it will delete\n   * the existing expiration before creating the new one.\n   */\n  s(key: Key, value: ReturnType<Fn>): void {\n    if (this.e.has(key)) {\n      this.d(key);\n    }\n\n    const cache = this.c;\n    const time = typeof this.t === 'function' ? this.t(key, value, cache) : this.t;\n\n    if (!isNumericValueValid(time)) {\n      throw new TypeError(`The expiration time must be a finite, non-negative number; received ${time as string}`);\n    }\n\n    const timeout = setTimeout(() => {\n      this.d(key);\n\n      const node = cache.g(key);\n\n      if (!node) {\n        return;\n      }\n\n      if (typeof this.r === 'function' && !this.r(key, node.v, time, cache)) {\n        if (node !== cache.h) {\n          cache.u(node, 'expiration reset', false);\n        } else if (cache.o) {\n          // Always notify, even if at the top of the cache.\n          cache.o.n('update', node, 'expiration reset');\n        }\n\n        this.s(key, node.v);\n      } else {\n        cache.d(node, 'expired');\n      }\n    }, time);\n\n    if (typeof timeout.unref === 'function') {\n      // If done in NodeJS, the timeout should have its reference removed to avoid\n      // hanging timers if collected while running.\n      timeout.unref();\n    }\n\n    this.e.set(key, timeout);\n  }\n}\n","import { Cache } from './Cache.js';\nimport type { GlobalStats, ProfileStats } from './internalTypes.js';\n\ninterface ProfileCounts {\n  c: number;\n  h: number;\n}\n\nconst nameToProfile = new Map<string, StatsManager<any>>();\n\nlet active = false;\n\nexport class StatsManager<Fn extends (...args: any[]) => any> {\n  /**\n   * The [c]ache listened to when collecting counts.\n   */\n  c: Cache<Fn>;\n  /**\n   * Method to [d]elete existing cache listeners.\n   */\n  d: (() => void) | undefined;\n  /**\n   * The [n]ame of the profile to manage in stats.\n   */\n  n: string;\n  /**\n   * The counts for the stats [p]rofile.\n   */\n  p: ProfileCounts = { c: 0, h: 0 };\n\n  constructor(cache: Cache<Fn>, statsName: string) {\n    this.c = cache;\n    this.n = statsName;\n\n    nameToProfile.set(statsName, this);\n\n    if (active) {\n      this.s();\n    }\n  }\n\n  /**\n   * Method to compute the [m]etrics for the profile stats.\n   */\n  m(): ProfileStats {\n    const { c: calls, h: hits } = this.p;\n    const usage = calls ? `${((hits / calls) * 100).toFixed(4)}%` : '0.0000%';\n\n    return { calls, hits, name: this.n, usage };\n  }\n\n  /**\n   * Method to [r]eset the counts.\n   */\n  r() {\n    this.p = { c: 0, h: 0 };\n  }\n\n  /**\n   * Method to [s]tart the collection of stats for the given profile.\n   */\n  s() {\n    const onAdd = () => {\n      ++this.p.c;\n    };\n    const onHit = () => {\n      ++this.p.c;\n      ++this.p.h;\n    };\n\n    this.d = () => {\n      this.c.off('add', onAdd);\n      this.c.off('hit', onHit);\n\n      this.d = undefined;\n\n      this.p.c = this.p.h = 0;\n    };\n\n    this.c.on('add', onAdd);\n    this.c.on('hit', onHit);\n  }\n}\n\n/**\n * Clear all existing stats stored, either of the specific profile whose name is passed,\n * or globally if no name is passed.\n */\nexport function clearStats(statsName?: string) {\n  if (!active) {\n    return;\n  }\n\n  if (statsName) {\n    const statsManager = nameToProfile.get(statsName);\n\n    if (statsManager) {\n      statsManager.r();\n    }\n  } else {\n    nameToProfile.clear();\n  }\n}\n\n/**\n * Get the stats of a given profile, or global stats if no `statsName` is given.\n */\nexport function getStats<Name extends string | undefined>(\n  statsName?: Name,\n): undefined extends Name ? GlobalStats | undefined : ProfileStats | undefined {\n  if (!active) {\n    console.warn('Stats are not being collected; please run \"startCollectingStats()\" to collect them.');\n    return;\n  }\n\n  if (statsName != null) {\n    const statsManager = nameToProfile.get(statsName);\n\n    const profileStats: ProfileStats = statsManager?.p.c\n      ? statsManager.m()\n      : {\n          calls: 0,\n          hits: 0,\n          name: statsName,\n          usage: getUsagePercentage(0, 0),\n        };\n    // @ts-expect-error - Conditional returns can be tricky.\n    return profileStats;\n  }\n\n  let calls = 0;\n  let hits = 0;\n\n  const profiles: Record<string, ProfileStats> = {};\n\n  nameToProfile.forEach((profile, statsName) => {\n    profiles[statsName] = profile.m();\n\n    calls += profile.p.c;\n    hits += profile.p.h;\n  });\n\n  const globalStats: GlobalStats = {\n    calls,\n    hits,\n    profiles,\n    usage: getUsagePercentage(calls, hits),\n  };\n\n  // @ts-expect-error - Conditional returns can be tricky.\n  return globalStats;\n}\n\n/**\n * Get the usage percentage based on the number of hits and total calls.\n */\nfunction getUsagePercentage(calls: number, hits: number): string {\n  return calls ? `${((hits / calls) * 100).toFixed(4)}%` : '0.0000%';\n}\n\n/**\n * Whether stats are currently being collected.\n */\nexport function isCollectingStats(): boolean {\n  return active;\n}\n\n/**\n * Start collecting stats.\n */\nexport function startCollectingStats(): void {\n  if (!active) {\n    active = true;\n\n    nameToProfile.forEach((profile) => {\n      profile.s();\n    });\n  }\n}\n\n/**\n * Stop collecting stats.\n */\nexport function stopCollectingStats(): void {\n  if (active) {\n    nameToProfile.forEach((profile) => {\n      profile.d?.();\n    });\n\n    active = false;\n  }\n}\n","import { Cache } from './Cache.js';\nimport { ExpirationManager } from './expires.js';\nimport type { Key, Memoize, Memoized, Options } from './internalTypes.js';\nimport { StatsManager } from './stats.js';\nimport { isMemoized } from './utils.js';\n\nexport type * from './internalTypes.js';\n\nexport const memoize: Memoize = function memoize<Fn extends (...args: any[]) => any, Opts extends Options<Fn>>(\n  fn: Fn | Memoized<Fn, Opts>,\n  options: Opts = {} as Opts,\n): Memoized<Fn, Opts> {\n  if (isMemoized(fn)) {\n    return memoize(fn.fn, Object.assign({}, fn.options, options));\n  }\n\n  if (typeof fn !== 'function') {\n    throw new TypeError(`Expected first parameter to be function; received ${typeof fn}`);\n  }\n\n  const cache = new Cache(options);\n  const memoized = createMemoizedMethod<Fn, Opts>(fn, cache, options.forceUpdate);\n\n  const { expires, statsName } = options;\n\n  memoized.cache = cache;\n  memoized.expirationManager = expires != null ? new ExpirationManager(cache, expires) : null;\n  memoized.fn = fn;\n  memoized.isMemoized = true;\n  memoized.options = options;\n  memoized.statsManager = statsName != null ? new StatsManager(cache, statsName) : null;\n\n  return memoized;\n};\n\nfunction createMemoizedMethod<Fn extends (...args: any) => any, Opts extends Options<Fn>>(\n  fn: Fn,\n  cache: Cache<Fn>,\n  forceUpdate: Opts['forceUpdate'],\n): Memoized<Fn, Opts> {\n  const memoized = function memoized(this: any, ...args: Parameters<Fn>): ReturnType<Fn> {\n    const key: Key = cache.k ? cache.k(args) : args;\n\n    let node = cache.g(key);\n\n    if (!node) {\n      node = cache.n(key, fn.apply(this, args) as ReturnType<Fn>);\n    } else if (node !== cache.h) {\n      cache.u(node, undefined, true);\n    } else if (cache.o) {\n      cache.o.n('hit', node);\n    }\n\n    return node.v;\n  } as Memoized<Fn, Opts>;\n\n  if (!forceUpdate) {\n    return memoized;\n  }\n\n  return function wrappedMemoized(this: any, ...args: Parameters<Fn>): ReturnType<Fn> {\n    if (!forceUpdate(args) || !cache.has(args)) {\n      return memoized.apply(this, args);\n    }\n\n    const value: ReturnType<Fn> = fn.apply(this, args);\n\n    cache.set(args, value, 'forced');\n\n    return value;\n  } as Memoized<Fn, Opts>;\n}\n\nexport { clearStats, isCollectingStats, getStats, startCollectingStats, stopCollectingStats } from './stats.js';\n"],"names":[],"mappings":"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"}